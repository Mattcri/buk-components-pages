<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Previred Dinamic Tables</title>
  <link rel="stylesheet" href="../css/grid-system.css">
  <link rel="stylesheet" href="../css/utilities-spaces-23.css">
  <link rel="stylesheet" href="../css/main-23.css">

  <style>
    #app table .buk-grid [class*="buk-col"] {
      padding-top: 0;
      padding-bottom: 0;
    }
  </style>
  
</head>
<body>

  <section class="buk-py-11 buk-py-lg-15">
    <div class="boxer">
      <h2 class="txt-md-center buk-mb-6">Proyecto previred</h2>

      <div id="app">
        <div class="buk-my-3">
          <select @change="selectMonth">
            <option v-for="(item, index) in getMonthsNameAndKeys" :key="item[index]" :value="item.idMonth">
              {{ item.nameMonth }}
            </option>
          </select>
          <div class="buk-mt-3">
            <h5>{{ month }}</h5>
            <p>Nodo: {{ keyMonth }}</p>
          </div>
        </div>

        <div class="buk-grid">
          <div class="buk-col buk-col-md-7 buk-col-lg-7">
            <tables-data-currencys :current="currencyData" :month="month" />
          </div>
          
          <div class="buk-col buk-col-md-5 buk-col-lg-5">
            <h3>{{ msg }}</h3>
            {{ legalData }}
          </div>
          <div class="buk-col">
            <tables-legal-data :current="previredAllData[keyMonth]" />
          </div>
        </div>
      </div>

    </div>
  </section>

  <script src="https://unpkg.com/vue@3/dist/vue.global.js" defer></script>

  <script type="module" defer>
    // import countBtn from '../js/vue/components/pr-count-btn.js'
    import tablesDataCurrencys from '../js/vue/components/tablesCurrency.js'
    import tablesLegalData from '../js/vue/components/tablesLegalData.js'

    const URL = 'https://mattguz.github.io/previred-project/datos_indicadores_previsionales.json'

    const app = Vue.createApp({
      setup() {
        const previredAllData = Vue.ref({})
        const month = Vue.ref({})
        const keyMonth = Vue.ref({})

        const fetchSetupData = async () => {
          try {
            const response = await fetch(URL)

            if (!response.ok) {
              throw new Error(`Solicitud con estado: ${response.statusText}`);
            }

            const data = await response.json()
            const lastItem = Object.keys(data).pop()

            // currentMonthData.value = data[lastItem]
            previredAllData.value = data
            month.value = data[lastItem]["valor_utm_uta"]["valor"][0]
            keyMonth.value = lastItem

          } catch (error) {
            console.error(error.message)
          }
        }

        fetchSetupData()

        return {
          previredAllData,
          month,
          keyMonth
        }

      },
      data() {
        return {
          msg: 'Hola Vue.js',
        }
      },
      methods: {
        selectMonth(event) {
          let selectedMonth = this.getMonthsNameAndKeys.find(e => e.idMonth === event.target.value)
          let nameMonth = selectedMonth ? selectedMonth.nameMonth : null

          this.keyMonth = event.target.value
          this.month = nameMonth.toString()
        },
        
      },
      computed: {
        getMonthsNameAndKeys() {
          const keysMonths = []

          Object.keys(this.previredAllData).forEach((key, index) => {
            let monthsKeys = this.previredAllData[key]["valor_utm_uta"]["valor"]

            let buildObj = {
              idMonth: key,
              nameMonth: monthsKeys[0]
            }

            keysMonths.push(buildObj)
          })

          return keysMonths.reverse()
        },
        currencyData() {
          const selectedMonthData = this.previredAllData[this.keyMonth]

          return {
            valor_uf: selectedMonthData ? selectedMonthData.valor_uf : null,
            valor_utm_uta: selectedMonthData ? selectedMonthData.valor_utm_uta : null,
            deposito_convenido: selectedMonthData ? selectedMonthData.deposito_convenido : null
          };
        },
        legalData() {
          const selectedMonthData = this.previredAllData[this.keyMonth]

          let findLegalData = null

          if(selectedMonthData) {
            findLegalData = Object.entries(selectedMonthData).reduce((acumulador, [key, value]) => {
              if (key !== 'valor_uf' && key !== 'deposito_convenido') {
                acumulador[key] = value
              }
              return acumulador
            }, {})
          }

          console.log('legal: ', findLegalData);

          return findLegalData 

        }
      },
      // beforeCreate() {
      //   fetch(URL)
      //     .then(response => {
      //       console.log('status respose', response.status)
      //       if (!response.ok) {
      //         throw new Error(`Solicitud con estado: ${response.statusText}`)
      //       }
      //       return response.json()
      //     })
      //     .then(data => {
      //       this.previredAllData = data

      //       const lastItem = Object.keys(this.previredAllData).pop()

      //       this.currentMonthData = data[lastItem]
      //       this.month = data[lastItem]["valor_utm_uta"]["valor"][0]
      //       this.keyMonth = lastItem

      //       console.log('++++++')


      //     })
      //     .catch(error => console.error(error.message))
        
      // },

      components: {
        tablesDataCurrencys,
        tablesLegalData
      }

    })

    app.mount('#app')

  </script>
  
</body>
</html>